### 聊聊四次挥⼿

#### 四次挥⼿第⼀步

发送一个 FIN 包, 需要消耗一个序列号. -> TCP的状态为 FIN-WAIT-1

##### 什么时候触发FIN报文

- 程序调⽤ close
- 程序异常退出-内核帮忙善后

##### FIN 报⽂可以携带数据吗?

可以, 但是不常见.

##### FIN 报⽂如果不携带数据, 需要消耗序列号吗?

需要的, 消耗序列号之和是否需要回应有关. FIN包需要对方确认, 所以需要消耗.

##### ⼀⽅发送 FIN 报⽂以后, 还能发送数据或者接收对⽅的数据吗?

不能发送了, 否则会管道异常. 但是可以继续接收.



#### 四次挥⼿第⼆步

服务端收到 FIN 包以后回复确认 ACK 报⽂给客户端, 服务端进⼊ CLOSE_WAIT, 客户端收到 ACK 以后进⼊FIN-WAIT-2状态.



#### 四次挥⼿第三步

服务端也没有数据要发送了, 发送 FIN 报⽂给客户端, 然后进⼊LAST-ACK 状态, 等待客户端的 ACK.

同前⾯⼀样如果 FIN 段没有携带数据, 也需要消耗⼀个序列号.



#### 四次挥⼿第四步

客户端收到服务端的 FIN 报⽂以后,回复 ACK 报⽂⽤来确认第三步⾥的 FIN 报⽂,进⼊TIME_WAIT状态,等待 2 个 MSL 以后进⼊ CLOSED状态. 服务端收到 ACK 以后进⼊CLOSED状态.



#### 四次挥手TCP状态

##### Client

1. ESTABLISHED
2. FIN-WAIT-1
3. FIN-WAIT-2
4. TIME-WAIT
5. CLOSED

##### Server

1. ESTABLISHED
2. CLOSE-WAIT
3. LAST-ACK
4. CLOSE



#### 为什么挥⼿要四次, 变为三次可以吗?

可以, 像三次握手一样. SYN + ACK 一个包回复. 挥手时也可以 FIN + ACK 一起回复.



#### 同时关闭



























